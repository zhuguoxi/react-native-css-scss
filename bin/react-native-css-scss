#!/usr/bin/env node

var Rncs = require('../build/index.js');
var cssOpera = new Rncs();
var path = require('path');
var fs = require('fs');
var argv = require('minimist')(process.argv.slice(2));
var chokidar = require('chokidar');
var watch = argv['w'] || argv['watch'];
var prettyPrint = argv['p'] || argv['pretty'] ? true : false;
var inputPut = (argv['i'] || argv['input'] ) || argv._[0] ;
var suffix = (argv['s'] || argv['suffix'] ) || '.js';
var useEs6 = ( argv['e'] || argv['es6'] ) ? true : false;

var literalObject = argv['l'] || argv['literal'] ? true : false;
var glob = require("glob");

suffix = suffix[0] !== '.' ? '.'+suffix : suffix;
/**
 * 检索某个目录下，符合这些正则表达式的文件列表
 */
var pattern2fileList = function (src, patternList, callback) {
    var pattern = '{' + patternList.join(',') + '}';

    glob(pattern, {cwd: src, mark: true}, callback);
}

/**
 * css编译入口
 */
var cssPa = function (options) {
    let input = options.input,
         output = options.output,
         callback = options.callback;
    
    var reInput = path.resolve(process.cwd(), input);
    if( !output ){
        output = path.join(
            path.dirname(reInput),
            path.basename( reInput, path.extname(reInput) )
        )+suffix;
    }
    try{
    console.log(literalObject)
        cssOpera.parse(reInput, output, prettyPrint, literalObject, ()=> {
            callback && callback.apply(null, arguments);
            console.log(input, 'compile is ok √')
        }, useEs6);
    }catch (err){
        console.log(err)
    }

}

var watchAction = function (watchPath) {
    var watcher = chokidar.watch(watchPath, {
        ignored: /[\/\\]\./, persistent: true
    }).on('change', function (path) {
        console.log(path, 'has been changed ');
        cssPa({
            input: path
        });
    });
    console.log(' ============= react-native-css-scss run watch =============');
    return watcher
}


if (inputPut) {
    var patternList = [inputPut,'*.css'];      //{,}中逗号后面不能有空格
    var src = process.cwd();

    pattern2fileList(src, patternList, function (err, fileList) {
        if (err) {
            console.log(err);
            return;
        }
        debugger
        fileList.forEach((item)=>{
            cssPa({input:item})
        });

        watchAction(inputPut)

    });
}
